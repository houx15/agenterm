id: pairing-coding
name: Pairing Coding
description: Two-agent pairing flow. Planner writes the spec, codebase-reader surfaces constraints, then builder and reviewer iterate to delivery.
phases:
    - name: Implement
      agent: codex
      role: implementer
      description: ""
workflow:
    plan:
        enabled: true
        roles:
            - name: planner
              responsibilities: Clarify scope, split milestones, and write a task spec to .orchestra/spec.md.
              allowed_agents:
                - claude-code
                - claude-code-opus
              suggested_prompt: |-
                You are the planning agent for this task.

                Task: {task_title}
                Description: {task_title}

                Your job:
                1. Understand the task goal and identify any unknowns or risks.
                2. Use codex mcp or gemini mcp to understand the current codebase.
                3. Write a concise task spec to the file .orchestra/spec.md with these sections:
                   ## Goal
                   ## Acceptance Criteria
                   ## Out of Scope
                   ## Milestones
                3. Keep each section brief and actionable.
                4. When the spec file is written, output "DONE" and stop.
              mode: planner
              inputs_required:
                - task_id
                - project_id
              actions_allowed:
                - get_project_status
                - create_task
                - write_task_spec
                - create_session
              handoff_to:
                - codebase-reader
              completion_criteria:
                - .orchestra/spec.md written with Goal, Acceptance Criteria, Milestones sections
                - Agent outputs DONE or exits cleanly
              outputs_contract:
                type: file
                required:
                    - .orchestra/spec.md
              gates:
                pass_condition: spec file written
              retry_policy:
                max_iterations: 2
                escalate_on:
                    - spec_missing
                    - agent_error
            - name: codebase-reader
              responsibilities: Explore the repository and append architecture constraints to the task spec.
              allowed_agents:
                - gemini-cli
                - opencode-ark
                - opencode-glm
                - kimi-cli
                - opencode-minimax
                - codex
                - opencode-qwen
              suggested_prompt: |-
                You are the codebase analysis agent for this task.

                Task: {task_title}
                Spec: {spec_path}

                Your job:
                1. Read the task spec at {spec_path}.
                2. Explore the repository structure relevant to the task scope.
                3. Identify: key files to change, existing patterns to follow, integration points, and risks.
                4. Append a "## Codebase Context" section to {spec_path} with your findings.
                5. When done, output "DONE" and stop.
              mode: planner
              inputs_required:
                - task_id
                - project_id
                - spec_path
              actions_allowed:
                - get_project_status
                - create_task
                - write_task_spec
                - create_session
              handoff_to:
                - builder
              completion_criteria:
                - Codebase Context section appended to the spec file
                - Agent outputs DONE or exits cleanly
              outputs_contract:
                type: file
                required:
                    - .orchestra/spec.md
              gates:
                pass_condition: codebase context written
              retry_policy:
                max_iterations: 2
                escalate_on:
                    - agent_error
        stage_policy:
            enter_gate: user_approval
            exit_gate: spec_written
            max_parallel_worktrees: 1
    build:
        enabled: true
        roles:
            - name: builder
              responsibilities: Implement the plan in small focused commits inside the assigned worktree.
              allowed_agents:
                - codex
                - opencode
                - opencode-ark
                - opencode-glm
                - gemini-cli
                - kimi-cli
                - opencode-minimax
                - opencode-qwen
              suggested_prompt: |-
                You are the implementation agent for this task.

                Task: {task_title}
                Spec: {spec_path}

                Your job:
                1. Read the full task spec at {spec_path} including the Codebase Context section.
                2. Implement the required changes in small focused commits.
                3. Run existing tests after each logical change to verify nothing breaks.
                4. Do not change code unrelated to the task scope.
                5. When implementation is complete and tests pass, make a final commit with the message containing [READY_FOR_REVIEW].
                6. Output "DONE" and stop.
              mode: worker
              inputs_required:
                - task_id
                - project_id
                - spec_path
                - worktree_id
              actions_allowed:
                - send_command
                - read_session_output
                - is_session_idle
                - close_session
              handoff_to:
                - reviewer
              completion_criteria:
                - All required changes committed
                - Tests passing
                - Final commit message contains [READY_FOR_REVIEW]
              outputs_contract:
                type: commit
                required:
                    - READY_FOR_REVIEW commit
              gates:
                pass_condition: ready_for_review_commit
              retry_policy:
                max_iterations: 3
                escalate_on:
                    - test_failure
                    - build_error
                    - agent_error
            - name: reviewer
              responsibilities: Review the implementation against the spec and clearly list any issues before merge.
              allowed_agents:
                - gemini-cli
                - opencode-ark
                - opencode-glm
                - kimi-cli
                - opencode-minimax
                - codex
                - opencode-qwen
              suggested_prompt: |-
                You are the code reviewer for this task.

                Task: {task_title}
                Spec: {spec_path}

                Your job:
                1. Read the task spec at {spec_path}.
                2. Review all changes vs the base branch using: git diff main...HEAD
                3. Check: correctness vs acceptance criteria, code quality, test coverage, edge cases, and regressions.
                4. If issues found: list each with file path, line reference, severity (critical/minor), and suggested fix.
                5. If no issues: output "LGTM".
                6. Output "DONE" when your review is complete.
              mode: reviewer
              inputs_required:
                - task_id
                - project_id
                - spec_path
                - session_id
              actions_allowed:
                - send_command
                - read_session_output
                - is_session_idle
              completion_criteria:
                - Explicit LGTM or issue list produced
                - Agent outputs DONE or exits cleanly
              outputs_contract:
                type: report
                required:
                    - review verdict
              gates:
                pass_condition: lgtm_or_issues_listed
              retry_policy:
                max_iterations: 2
                escalate_on:
                    - agent_error
        stage_policy:
            enter_gate: plan_complete
            exit_gate: review_passed
            max_parallel_worktrees: 2
    test:
        enabled: false
        roles: []
