---
id: compound-engineering
name: Compound Engineering
description: Structured multi-agent workflow with planning, parallel build execution,
  and integration hardening.
phases:
- name: Implement
  agent: codex
  role: implementer
  description: ''
workflow:
  plan:
    enabled: true
    roles:
    - name: requirements-analyst
      responsibilities: Refine goals, constraints, and acceptance criteria from user
        intent.
      allowed_agents:
      - claude-code
      - claude-code-opus
      suggested_prompt: |-
        You are the planning agent for compound engineering.

        Task: {task_title}

        Required output:
        1. Analyze repository baseline and constraints.
        2. Split the feature into parallel worktrees first.
        3. For each worktree, define:
           - worktree/branch name
           - scope and boundaries
           - dependency order
           - acceptance criteria
        4. Create one spec doc per worktree under docs/.
        5. Define execution loop inside each worktree: coder -> reviewer -> bug-fix iteration -> merge-ready.
        6. Summarize phase plan and recommended max parallelism.

        Keep the plan executable by orchestrator tools; do not implement code.
      mode: planner
      inputs_required:
      - goal
      actions_allowed:
      - get_project_status
      - create_task
      - write_task_spec
      - create_session
      completion_criteria:
      - Per-worktree specs written under docs/
      - Parallel worktree plan proposed and user-confirmed
      outputs_contract:
        type: plan_result
        required:
        - strategy
        - task_graph
        - worktree_specs
      gates:
        pass_condition: user_plan_approved
        requires_user_approval: true
      retry_policy:
        escalate_on:
        - unclear_scope
        - spec_missing
        - agent_error
        max_iterations: 2
    stage_policy:
      enter_gate: user_approval
      exit_gate: user_plan_approved
      max_parallel_worktrees: 0
  build:
    enabled: true
    roles:
    - name: coder
      responsibilities: Deliver implementation tasks in dedicated worktrees.
      allowed_agents:
      - codex
      - opencode-ark
      - opencode-glm
      - gemini-cli
      - kimi-cli
      - opencode-minimax
      - opencode-qwen
      suggested_prompt: |-
        You are the coder for one assigned worktree.

        Context:
        - Spec: {spec_path}
        - Worktree: {worktree_path}
        - Branch: {branch_name}

        Rules:
        1. Implement exactly the assigned scope from {spec_path}.
        2. Keep commits focused, testable, and easy to review.
        3. Run relevant tests/checks before committing.
        4. Report what changed, what remains, and any known risk.
        5. If reviewer raises issues, fix only listed issues and recommit.

        End response with DONE when complete.
      mode: worker
      inputs_required:
      - spec_path
      - worktree_id
      actions_allowed:
      - send_command
      - read_session_output
      - is_session_idle
      - close_session
      completion_criteria:
      - Spec implemented and committed
      outputs_contract:
        type: work_result
        required:
        - commit_sha
        - summary
      gates:
        pass_condition: implementation_commit_ready
      retry_policy:
        escalate_on:
        - no_progress
    - name: reviewer
      responsibilities: Review code quality, correctness, and contract compliance
        continuously.
      allowed_agents:
      - codex
      - opencode-ark
      - opencode-glm
      - gemini-cli
      - kimi-cli
      - opencode-minimax
      - opencode-qwen
      suggested_prompt: |-
        You are the reviewer for one assigned worktree.

        Context:
        - Spec: {spec_path}
        - Worktree: {worktree_path}
        - Branch: {branch_name}

        Review procedure:
        1. Review code against {spec_path} and correctness expectations.
        2. Classify issues by severity and make them actionable.
        3. Write/update docs/bug-{feature-name}.md using this structure:
           - OPEN ISSUES
           - FIXED ISSUES
           - BLOCKERS
        4. If no open issues remain, leave OPEN ISSUES empty and state PASS clearly.

        End response with DONE when complete.
      mode: reviewer
      inputs_required:
      - spec_path
      - commit_sha
      - worktree_id
      actions_allowed:
      - send_command
      - read_session_output
      - is_session_idle
      completion_criteria:
      - Review verdict is pass
      outputs_contract:
        type: review_result
        required:
        - verdict
        - issues
      gates:
        pass_condition: verdict_pass_or_issues_logged
      retry_policy:
        escalate_on:
        - same_issue_repeated
    - name: merger
      responsibilities: Expand automated tests and quality checks for each delivered
        slice.
      allowed_agents:
      - codex
      - opencode-ark
      - kimi-cli
      - gemini-cli
      - opencode-glm
      - opencode-minimax
      - opencode-qwen
      suggested_prompt: |-
        You are the merge operator for completed worktrees.

        Context: list of candidate worktrees/branches will be provided.

        Rules:
        1. Merge only worktrees that passed review and have no OPEN ISSUES.
        2. Merge one branch at a time; verify build/tests after each merge.
        3. If conflicts occur, resolve safely and document resolution.
        4. After successful merge, clean up merged worktree and branch.
        5. Report final merged order and any residual risks.

        End response with DONE when complete.
      mode: reviewer
      inputs_required:
      - worktree_id
      - branch_name
      actions_allowed:
      - send_command
      - read_session_output
      - is_session_idle
      - close_session
      - merge_worktree
      - resolve_merge_conflict
      completion_criteria:
      - All required checks pass
      outputs_contract:
        type: test_result
        required:
        - summary
        - failed_cases
      gates:
        pass_condition: merged_and_cleaned
      retry_policy:
        escalate_on:
        - flaky_tests
    stage_policy:
      enter_gate: plan_complete
      exit_gate: build_complete
      max_parallel_worktrees: 4
  test:
    enabled: true
    roles:
    - name: integration-verifier
      responsibilities: Validate integration, merge readiness, and operational stability.
      allowed_agents:
      - opencode-ark
      - opencode-glm
      - gemini-cli
      - kimi-cli
      - opencode-minimax
      - codex
      - opencode-qwen
      suggested_prompt: |-
        You are the final integration verifier.

        Context:
        - Task: {task_title}
        - Spec: {spec_path}

        Deliverables:
        1. Produce integration validation checklist from specs.
        2. Run automatable checks and summarize results.
        3. Identify required manual checks and expected outcomes.
        4. Output release-readiness verdict: PASS / FAIL with reasons.

        End response with DONE when complete.
      mode: tester
      inputs_required:
      - spec_path
      actions_allowed:
      - send_command
      - read_session_output
      - is_session_idle
      - close_session
      completion_criteria:
      - All required checks pass
      outputs_contract:
        type: test_result
        required:
        - summary
        - failed_cases
      gates:
        pass_condition: failed_cases == 0
      retry_policy:
        escalate_on:
        - flaky_tests
    stage_policy:
      enter_gate: build_complete
      exit_gate: integration_verification_complete
      max_parallel_worktrees: 1
